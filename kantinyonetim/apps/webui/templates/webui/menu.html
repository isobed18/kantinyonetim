{% extends 'webui/base.html' %}
{% block content %}
<script>ensureAuth();</script>
<style>
.menu-category {
    margin-bottom: 30px;
}
.menu-category h3 {
    border-bottom: 2px solid #ccc;
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.menu-item {
    display: flex;
    align-items: center;
    border: 1px solid #eee;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    background-color: #f9f9f9;
}
.menu-item-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 15px;
}
.menu-item-details {
    flex-grow: 1;
}
.menu-item-details strong {
    display: block;
    margin-bottom: 5px;
}
.cart-popup {
    position: fixed;
    bottom: 100px; 
    right: 20px;
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 15px;
    width: 350px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    max-height: 80vh;
    overflow-y: auto;
}
.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.cart-items {
    flex-grow: 1;
    margin-bottom: 10px;
}
.cart-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px dashed #eee;
}
.cart-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 0;
}
.cart-item-name {
    flex-grow: 1;
}
.cart-quantity-controls button {
    margin: 0 5px;
    padding: 5px 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
    cursor: pointer;
}
.cart-actions button {
    margin-right: 10px;
}
.cart-empty {
    color: #777;
}
.cart-toggle-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    z-index: 1001;
}
.cart-toggle-btn.closed {
    border-radius: 8px;
    width: auto;
    height: auto;
    padding: 10px 15px;
    font-size: 1rem;
}
#cartPopup {
    display: none; /* BaÅŸlangÄ±Ã§ta gizli */
}
</style>

<h2>MenÃ¼</h2>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
    <div>
        <button onclick="loadMenu()" class="btn-primary">Yenile</button>
    </div>
    <div class="muted">Sepetteki Ã¼rÃ¼nler: <span id="cartCount">0</span></div>
</div>

<div id="orderForOthers" style="display:none; margin-bottom:16px; padding:12px; background:#f8f9fa; border-radius:6px;">
    <h4 style="margin:0 0 8px 0">MÃ¼ÅŸteri Ä°Ã§in SipariÅŸ OluÅŸtur</h4>
    <div style="display:flex; gap:8px; align-items:center">
        <input id="customerUsername" placeholder="MÃ¼ÅŸteri kullanÄ±cÄ± adÄ±" style="flex:1"/>
        <button onclick="setOrderForCustomer()" class="btn-secondary">MÃ¼ÅŸteri Ayarla</button>
        <button onclick="clearOrderForCustomer()" class="btn-outline">Temizle</button>
    </div>
    <div id="customerInfo" class="muted" style="margin-top:8px"></div>
</div>

<div id="menuManagement" style="display:none; margin-bottom:16px; padding:12px; background:#f0f9ff; border-radius:6px; border:1px solid #0ea5e9;">
    <h4 style="margin:0 0 8px 0; color:#0c4a6e">MenÃ¼ YÃ¶netimi</h4>
    <div style="display:flex; flex-direction: column; gap:8px;">
        <input id="newMenuItemName" placeholder="ÃœrÃ¼n adÄ±" class="form-input"/>
        <textarea id="newMenuItemDescription" placeholder="AÃ§Ä±klama" class="form-input" rows="2"></textarea>
        <div style="display:flex; gap:8px; align-items:center;">
            <input id="newMenuItemPrice" placeholder="Fiyat" type="number" step="0.01" style="width:100px" class="form-input"/>
            <select id="newMenuItemCategory" class="status-select">
                <option value="ana_yemek">Ana Yemek</option>
                <option value="icecek">Ä°Ã§ecek</option>
                <option value="tatli">TatlÄ±</option>
                <option value="aperatif">Aperatif</option>
            </select>
            <input type="file" id="newMenuItemImage" accept="image/*">
        </div>
        <button onclick="createMenuItem()" class="btn-success">Ã–ÄŸe OluÅŸtur</button>
    </div>
    <div id="menuItemStatus" class="muted" style="margin-top:8px"></div>
</div>
<div id="menu-container"></div>

<button id="cartToggleButton" class="cart-toggle-btn" onclick="toggleCart()">ðŸ›’ <span id="cartItemCount">0</span></button>

<div id="cartPopup" class="cart-popup">
    <div class="cart-header">
        <h3>Sepet</h3>
        <button onclick="toggleCart()" class="btn-outline btn-small">Kapat</button>
    </div>
    <div id="cartItems" class="cart-items"></div>
    <div class="cart-actions">
        <button onclick="clearCart()" class="btn-outline">Sepeti Temizle</button>
        <button onclick="confirmOrder()" class="btn-primary">SipariÅŸi Onayla</button>
    </div>
    <div id="cartStatus" class="muted"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  let currentUserRole = 'customer';
  let orderForCustomer = null;
  let isCartOpen = false;
  
  function updateCartCount() {
    const count = cart.reduce((a, c) => a + c.qty, 0);
    const cartCountElement = document.getElementById('cartCount');
    const cartItemCountElement = document.getElementById('cartItemCount');
    const toggleButton = document.getElementById('cartToggleButton');

    if (cartCountElement) {
        cartCountElement.innerText = count;
    }
    if (cartItemCountElement) {
        cartItemCountElement.innerText = count;
    }
    
    if (toggleButton) {
        if (count > 0) {
            toggleButton.innerHTML = `ðŸ›’ <span id="cartItemCount">${count}</span>`;
            toggleButton.classList.remove('closed');
        } else {
            toggleButton.innerHTML = `Sepet BoÅŸ`;
            toggleButton.classList.add('closed');
        }
    }
}
  
function toggleCart() {
    const cartPopup = document.getElementById('cartPopup');
    if (cartPopup) {
        isCartOpen = !isCartOpen;
        cartPopup.style.display = isCartOpen ? 'flex' : 'none';
        console.log(`Sepet durumu gÃ¼ncellendi. isCartOpen: ${isCartOpen}`);
    }
}
  
  async function loadCurrentUserRole() {
      try {
          const res = await api('/api/users/me/');
          if (res.ok) {
              const me = await res.json();
              currentUserRole = me.role || 'customer';
              if (currentUserRole === 'staff' || currentUserRole === 'admin') {
                  document.getElementById('orderForOthers').style.display = 'block';
                  document.getElementById('menuManagement').style.display = 'block';
              }
              loadMenu();
          }
      } catch (e) {
          console.error('Failed to load user role:', e);
      }
  }
  function openCart() {
    const cartPopup = document.getElementById('cartPopup');
    if (cartPopup && !isCartOpen) {
        isCartOpen = true;
        cartPopup.style.display = 'flex';
        console.log(`Sepet aÃ§Ä±ldÄ±. isCartOpen: ${isCartOpen}`);
    }
}
  function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      updateCartCount();
  }
  
  function renderCart() {
      const cartItemsDiv = document.getElementById('cartItems');
      if (!cartItemsDiv) return;
      if (cart.length === 0) {
          cartItemsDiv.innerHTML = '<div class="cart-empty">Sepet boÅŸ</div>';
          return;
      }
      const itemsHtml = cart.map(line => `
          <div class="cart-item">
              <div class="cart-item-name">${line.menu_item_name}</div>
              <div class="cart-quantity-controls">
                  <button onclick="dec(${line.menu_item})">-</button>
                  <span>${line.qty}</span>
                  <button onclick="inc(${line.menu_item})">+</button>
              </div>
              <div>â‚º${(Number(line.price) * line.qty).toFixed(2)}</div>
              <button onclick="rem(${line.menu_item})" class="btn-small btn-danger">Sil</button>
          </div>
      `).join('');
      cartItemsDiv.innerHTML = itemsHtml;
  }
  
  function inc(id) {
      const idx = cart.findIndex(l => l.menu_item === id);
      if (idx >= 0) { cart[idx].qty += 1; saveCart(); }
  }
  function dec(id) {
      const idx = cart.findIndex(l => l.menu_item === id);
      if (idx >= 0) {
          cart[idx].qty -= 1; if (cart[idx].qty <= 0) cart.splice(idx,1); saveCart();
      }
  }
  function rem(id) {
      cart = cart.filter(l => l.menu_item !== id); saveCart();
  }
  function clearCart() { cart = []; saveCart(); }
  function add(menuItemId, name, price) {
    const qty = parseInt(document.getElementById(`qty_${menuItemId}`).value || '1', 10);
    const existing = cart.find(l => l.menu_item === menuItemId);

    if (existing) {
        existing.qty += qty;
    } else {
        cart.push({ menu_item: menuItemId, menu_item_name: name, price: String(price), qty });
    }

    saveCart();
    // Sepeti her Ã¼rÃ¼n eklendiÄŸinde aÃ§
    openCart();
}
  
  async function loadMenu() {
      const res = await fetch('/api/menu-items/');
      const items = await res.json();
      
      const menuContainer = document.getElementById('menu-container');
      menuContainer.innerHTML = '';
      
      const categories = {
          'ana_yemek': 'Ana Yemekler',
          'icecek': 'Ä°Ã§ecekler',
          'tatli': 'TatlÄ±lar',
          'aperatif': 'Aperatifler'
      };
      
      for (const category in categories) {
          const categoryItems = items.filter(item => item.category === category);
          if (categoryItems.length > 0) {
              let categoryHtml = `<div class="menu-category"><h3>${categories[category]}</h3>`;
              categoryItems.forEach(item => {
                  let actionButtonsHtml = '';
                  
                  const escapedName = item.name.replace(/'/g, "\\'");
                  const escapedDescription = item.description ? item.description.replace(/'/g, "\\'") : '';
                  
                  let addButtonHtml = `
                      <div>
                          <span>â‚º${item.price}</span>
                          <input id="qty_${item.id}" value="1" style="width:60px" ${!item.is_available ? 'disabled' : ''}/>
                          <button onclick="add(${item.id}, '${escapedName}', '${item.price}')" ${!item.is_available ? 'disabled' : ''} class="btn-small">Ekle</button>
                      </div>
                  `;
  
                  if (currentUserRole === 'staff' || currentUserRole === 'admin') {
                      let managementButtonsHtml = `
                          <div style="display:flex; gap:8px;">
                              <button onclick="editMenuItem(${item.id}, '${escapedName}', '${item.price}', '${escapedDescription}', ${item.is_available})" class="btn-small btn-secondary">DÃ¼zenle</button>
                              <button onclick="deleteMenuItem(${item.id})" class="btn-small btn-danger">Sil</button>
                          </div>
                      `;
                      actionButtonsHtml = `${managementButtonsHtml}${addButtonHtml}`;
                  } else {
                      actionButtonsHtml = addButtonHtml;
                  }
                  
                  categoryHtml += `
                      <div class="menu-item">
                          <img src="${item.image || '/media/menu_images/default.png'}" alt="${item.name}" class="menu-item-image">
                          <div class="menu-item-details">
                              <strong>${item.name}</strong>
                              <span>${item.description || ''}</span>
                          </div>
                          <div style="margin-left:auto; display:flex; gap:8px;">
                              ${actionButtonsHtml}
                          </div>
                      </div>
                  `;
              });
              categoryHtml += `</div>`;
              menuContainer.innerHTML += categoryHtml;
          }
      }
  }
  
  async function createMenuItem() {
      const name = document.getElementById('newMenuItemName').value.trim();
      const description = document.getElementById('newMenuItemDescription').value.trim();
      const price = parseFloat(document.getElementById('newMenuItemPrice').value);
      const category = document.getElementById('newMenuItemCategory').value;
      const image = document.getElementById('newMenuItemImage').files[0];
      
      if (!name || !price || !description) { 
          showNotification('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun (ad, aÃ§Ä±klama, fiyat).', 'error');
          return;
      }
      
      showNotification('MenÃ¼ Ã¶ÄŸesi oluÅŸturuluyor...', 'info');
      
      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', description);
      formData.append('price', price);
      formData.append('category', category);
      formData.append('is_available', true);
      if (image) {
          formData.append('image', image);
      }
  
      try {
          const res = await api('/api/menu-items/', {
              method: 'POST',
              body: formData
          });
          
          if (res.ok) {
              showNotification('MenÃ¼ Ã¶ÄŸesi baÅŸarÄ±yla oluÅŸturuldu!', 'success');
              document.getElementById('newMenuItemName').value = '';
              document.getElementById('newMenuItemDescription').value = '';
              document.getElementById('newMenuItemPrice').value = '';
              document.getElementById('newMenuItemImage').value = '';
              loadMenu();
          } else {
              const errorData = await res.json();
              showNotification(`BaÅŸarÄ±sÄ±z: ${JSON.stringify(errorData)}`, 'error');
          }
      } catch (error) {
          showNotification('MenÃ¼ Ã¶ÄŸesi oluÅŸturulurken hata oluÅŸtu', 'error');
      }
  }
  
  async function editMenuItem(id, currentName, currentPrice, currentDescription, currentAvailable) {
      const newName = prompt('Yeni adÄ± girin:', currentName);
      if (!newName) return;
      
      const newPrice = prompt('Yeni fiyatÄ± girin:', currentPrice);
      if (!newPrice || isNaN(parseFloat(newPrice))) return;
      
      const newDescription = prompt('Yeni aÃ§Ä±klamayÄ± girin:', currentDescription);
      if (newDescription === null) return;
      
      const formData = new FormData();
      formData.append('name', newName);
      formData.append('price', parseFloat(newPrice));
      formData.append('description', newDescription);
      formData.append('is_available', currentAvailable);
      
      try {
          const res = await api(`/api/menu-items/${id}/`, {
              method: 'PATCH',
              body: formData
          });
          
          if (res.ok) {
              showNotification('MenÃ¼ Ã¶ÄŸesi baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
              loadMenu();
          } else {
              const errorData = await res.json();
              showNotification('GÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + JSON.stringify(errorData), 'error');
          }
      } catch (error) {
          showNotification('MenÃ¼ Ã¶ÄŸesi gÃ¼ncellenirken hata oluÅŸtu', 'error');
      }
  }
  
  async function deleteMenuItem(id) {
      if (!confirm('Bu menÃ¼ Ã¶ÄŸesini silmek istediÄŸinizden emin misiniz?')) {
          return;
      }
      try {
          const res = await api(`/api/menu-items/${id}/`, {
              method: 'DELETE'
          });
  
          if (res.ok) {
              showNotification('MenÃ¼ Ã¶ÄŸesi baÅŸarÄ±yla silindi.', 'success');
              loadMenu();
          } else {
              const errorData = await res.json();
              showNotification(`Silme baÅŸarÄ±sÄ±z: ${JSON.stringify(errorData)}`, 'error');
          }
      } catch (error) {
          showNotification('MenÃ¼ Ã¶ÄŸesi silinirken hata oluÅŸtu', 'error');
      }
  }
  
  async function toggleMenuItemStatus(id, currentStatus) {
      try {
          const res = await api(`/api/menu-items/${id}/`, {
              method: 'PUT',
              body: JSON.stringify({
                  is_available: !currentStatus
              })
          });
          
          if (res.ok) {
              showNotification(`MenÃ¼ Ã¶ÄŸesi ${!currentStatus ? 'etkinleÅŸtirildi' : 'devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±'} baÅŸarÄ±yla!`, 'success');
              loadMenu();
          } else {
              const errorData = await res.json();
              showNotification('Durum gÃ¼ncellenirken baÅŸarÄ±sÄ±z olundu: ' + JSON.stringify(errorData), 'error');
          }
      } catch (error) {
          showNotification('MenÃ¼ Ã¶ÄŸesi durumu gÃ¼ncellenirken hata oluÅŸtu', 'error');
      }
  }
  
  async function setOrderForCustomer() {
      const username = document.getElementById('customerUsername').value.trim();
      if (!username) {
          showNotification('LÃ¼tfen bir mÃ¼ÅŸteri kullanÄ±cÄ± adÄ± girin', 'error');
          return;
      }
      
      try {
          const res = await api(`/api/users/search/?username=${username}`);
          if (res.ok) {
              const users = await res.json();
              if (users.length > 0) {
                  orderForCustomer = users[0];
                  document.getElementById('customerInfo').innerHTML = `<span class="ok">Åžu mÃ¼ÅŸteri iÃ§in sipariÅŸ veriliyor: ${orderForCustomer.username} (${orderForCustomer.role})</span>`;
                  document.getElementById('customerUsername').value = '';
              } else {
                  document.getElementById('customerInfo').innerHTML = '<span class="err">KullanÄ±cÄ± bulunamadÄ±</span>';
              }
          } else {
              document.getElementById('customerInfo').innerHTML = '<span class="err">KullanÄ±cÄ± bulunamadÄ±</span>';
          }
      } catch (e) {
          document.getElementById('customerInfo').innerHTML = '<span class="err">KullanÄ±cÄ± bulunurken hata oluÅŸtu</span>';
      }
  }
  
  function clearOrderForCustomer() {
      orderForCustomer = null;
      document.getElementById('customerInfo').innerHTML = '';
      document.getElementById('customerUsername').value = '';
  }
  
  async function confirmOrder() {
      if (cart.length === 0) { 
          showNotification('Sepetiniz boÅŸ', 'error');
          return; 
      }
      
      showNotification('SipariÅŸiniz oluÅŸturuluyor...', 'info');
      
      const orderData = {
          items: cart
      };
      
      if (orderForCustomer && (currentUserRole === 'staff' || currentUserRole === 'admin')) {
          orderData.customer_id = orderForCustomer.id;
      }
      
      try {
          const res = await api('/api/orders/create-from-cart/', { 
              method: 'POST', 
              body: JSON.stringify(orderData) 
          });
          
          if (!res.ok) { 
              const errorData = await res.json();
              showNotification(`SipariÅŸ oluÅŸturulamadÄ±: ${errorData.detail}`, 'error');
              return; 
          }
          
          let data = null;
          try {
              data = await res.json();
          } catch (e) {
              console.warn("SipariÅŸ yanÄ±tÄ± boÅŸ gÃ¶vde iÃ§eriyor, ancak iÅŸlem baÅŸarÄ±lÄ± gÃ¶rÃ¼nÃ¼yor.");
          }
  
          const orderId = data ? data.id : 'Yok';
          showNotification('SipariÅŸ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
          
          cart = []; 
          saveCart();
          clearOrderForCustomer();
          localStorage.setItem('current_order_id', orderId);
          
          setTimeout(() => {
              window.location.href = `/orders/${orderId}`;
          }, 1500);
  
      } catch (error) {
          console.error('SipariÅŸ sÄ±rasÄ±nda bir beklenmedik hata oluÅŸtu:', error);
          showNotification('SipariÅŸ sÄ±rasÄ±nda bir beklenmedik sunucu hatasÄ± oluÅŸtu. LÃ¼tfen tekrar deneyin.', 'error');
      }
  }
  
  loadCurrentUserRole();
  renderCart();
  updateCartCount();
  </script>
  {% endblock %}